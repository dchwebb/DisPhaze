#include "stm32f4xx.h"
#include "initialisation.h"
#include <cmath>
#include <cstdlib>
#include <algorithm>

// LUT sizes are probably all going to be constant
#define LUTSIZE 1024

// used to adjust pitch of oscillator two relative to oscillator one
enum RelativePitch {
	NONE,
	OCTAVEDOWN,
	OCTAVEUP
};
RelativePitch RelPitch = NONE;
CalibSettings calibration;

extern uint32_t SystemCoreClock;
extern volatile uint16_t ADC_array[ADC_BUFFER_LENGTH];

volatile uint32_t cyclecounter = 0;
volatile uint32_t overrun;			// For monitoring if samples are not being delivered to the DAC quickly enough
volatile bool DacRead = false;		// Tells the main loop when to queue up the next samples
volatile bool RingModOn = false;
volatile bool MixOn = false;
volatile bool ButtonDown = false;
volatile int Calibration = 0;
volatile int CalibBtn = 0;
volatile float freq1 = 440;
volatile float freq2 = 440;
volatile float PhaseDist = 0.0f;
volatile float SamplePos1 = 0;
volatile float SamplePos2 = 0;
volatile float PD1Scale = 0.0f;
volatile float PD2Scale = 0.0f;
volatile float PDLut1 = 0;
volatile uint8_t PDLut2 = 0;		// Which PD LUT is being used for DAC2
volatile uint16_t PD2Type = 0;		// Temporary value to use with hysterisis
volatile float VCALevel;
volatile uint16_t Pitch;
volatile int16_t FineTune = 0;
volatile int16_t CoarseTune = 0;
volatile float TuningOffset = 0.0f;
volatile float TuningScale = 0.0f;
float SineLUT[LUTSIZE];
float PitchLUT[LUTSIZE];

// Create aliases for ADC inputs
volatile uint16_t& ADC_PITCH = ADC_array[0];	// PB0 ADC12_IN8   Pin 27
volatile uint16_t& ADC_FTUNE = ADC_array[7];	// PB1 ADC12_IN9   Pin 26
volatile uint16_t& ADC_OSC1TYPE = ADC_array[2];	// PA1 ADC123_IN1  Pin 15
volatile uint16_t& ADC_OSC2TYPE = ADC_array[3];	// PA2 ADC123_IN2  Pin 16
volatile uint16_t& ADC_PD2AMT = ADC_array[4];	// PA3 ADC123_IN3  Pin 17
volatile uint16_t& ADC_VCA = ADC_array[5];		// PC0 ADC123_IN10 Pin 8
volatile uint16_t& ADC_PD1AMT = ADC_array[6];	// PC2 ADC123_IN12 Pin 10
volatile uint16_t& ADC_CTUNE = ADC_array[1];	// PC4 ADC12_IN14  Pin 24
volatile uint16_t& ADC_PD1POT = ADC_array[8];	// PA7 ADC12_IN7   Pin 23
volatile uint16_t& ADC_PD2POT = ADC_array[9];	// PC1 ADC12_IN11  Pin 9

// Create phase distortion look up tables
const float PDSquareLUT[] = {0,0.000182,0.000446,0.000789,0.001206,0.001693,0.002248,0.002868,0.003549,0.004290,0.005087,0.005938,0.006841,0.007794,0.008795,0.009843,0.010935,0.012072,0.013250,0.014470,0.015730,0.017029,0.018366,0.019742,0.021155,0.022605,0.024091,0.025615,0.027175,0.028771,0.030405,0.032076,0.033786,0.035534,0.037322,0.039150,0.041021,0.042935,0.044895,0.046903,0.048960,0.051070,0.053237,0.055463,0.057754,0.060114,0.062551,0.065071,0.067684,0.070402,0.073238,0.082960,0.092174,0.100907,0.109182,0.117021,0.124446,0.131478,0.138135,0.144436,0.150398,0.156039,0.161373,0.166417,0.171183,0.175687,0.179939,0.183954,0.187742,0.191315,0.194682,0.197855,0.200842,0.203653,0.206296,0.208779,0.211110,0.213297,0.215346,0.217264,0.219058,0.220733,0.222295,0.223750,0.225102,0.226357,0.227520,0.228594,0.229584,0.230495,0.231329,0.232090,0.232783,0.233410,0.233974,0.234478,0.234926,0.235319,0.235660,0.235953,0.236198,0.236399,0.236557,0.236674,0.236753,0.236794,0.236800,0.236773,0.236713,0.236623,0.236503,0.236356,0.236182,0.235982,0.235758,0.235511,0.235242,0.234951,0.234640,0.234310,0.233961,0.233595,0.233211,0.232812,0.232396,0.231966,0.231522,0.231064,0.230593,0.230109,0.229614,0.229107,0.228589,0.228060,0.227521,0.226973,0.226415,0.225848,0.225272,0.224688,0.224096,0.223497,0.222890,0.222276,0.221655,0.221028,0.220394,0.219754,0.219108,0.218456,0.217799,0.217137,0.216469,0.215797,0.215120,0.214438,0.213751,0.213061,0.212366,0.211667,0.210964,0.210257,0.209547,0.208833,0.208115,0.207394,0.206670,0.205943,0.205212,0.204479,0.203742,0.203003,0.202261,0.201516,0.200769,0.200018,0.199266,0.198511,0.197753,0.196993,0.196231,0.195467,0.194700,0.193932,0.193161,0.192388,0.191613,0.190836,0.190057,0.189276,0.188494,0.187709,0.186923,0.186135,0.185346,0.184554,0.183761,0.182966,0.182170,0.181372,0.180573,0.179772,0.178969,0.178165,0.177360,0.176553,0.175745,0.174935,0.174124,0.173311,0.172497,0.171682,0.170866,0.170048,0.169229,0.168409,0.167587,0.166765,0.165941,0.165115,0.164289,0.163462,0.162633,0.161803,0.160972,0.160140,0.159307,0.158473,0.157638,0.156801,0.155964,0.155126,0.154286,0.153446,0.152604,0.151762,0.150918,0.150074,0.149228,0.148382,0.147535,0.146686,0.145837,0.144987,0.144136,0.143284,0.142431,0.141577,0.140723,0.139867,0.139011,0.138154,0.137296,0.136437,0.135577,0.134716,0.133855,0.132993,0.132130,0.131266,0.130401,0.129536,0.128670,0.127803,0.126935,0.126067,0.125198,0.124328,0.123457,0.122586,0.121713,0.120841,0.119967,0.119093,0.118218,0.117342,0.116466,0.115588,0.114711,0.113832,0.112953,0.112073,0.111193,0.110312,0.109430,0.108548,0.107665,0.106781,0.105897,0.105012,0.104126,0.103240,0.102353,0.101466,0.100578,0.099689,0.098800,0.097911,0.097020,0.096129,0.095238,0.094346,0.093453,0.092560,0.091666,0.090772,0.089877,0.088982,0.088086,0.087189,0.086292,0.085395,0.084497,0.083598,0.082699,0.081799,0.080899,0.079999,0.079097,0.078196,0.077294,0.076391,0.075488,0.074584,0.073680,0.072776,0.071871,0.070965,0.070059,0.069153,0.068246,0.067338,0.066430,0.065522,0.064614,0.063704,0.062795,0.061885,0.060974,0.060063,0.059152,0.058240,0.057328,0.056415,0.055502,0.054589,0.053675,0.052761,0.051846,0.050931,0.050015,0.049100,0.048183,0.047267,0.046350,0.045432,0.044514,0.043596,0.042677,0.041759,0.040839,0.039919,0.038999,0.038079,0.037158,0.036237,0.035315,0.034394,0.033471,0.032549,0.031626,0.030703,0.029779,0.028855,0.027931,0.027006,0.026081,0.025156,0.024230,0.023304,0.022378,0.021451,0.020524,0.019597,0.018669,0.017741,0.016813,0.015885,0.014956,0.014027,0.013097,0.012168,0.011238,0.010307,0.009377,0.008446,0.007514,0.006583,0.005651,0.004719,0.003787,0.002854,0.001921,0.000988,0.000054,-0.000879,-0.001813,-0.002748,-0.003682,-0.004617,-0.005552,-0.006488,-0.007423,-0.008359,-0.009295,-0.010232,-0.011168,-0.012105,-0.013042,-0.013980,-0.014918,-0.015855,-0.016794,-0.017732,-0.018671,-0.019610,-0.020549,-0.021488,-0.022428,-0.023368,-0.024308,-0.025248,-0.026188,-0.027129,-0.028070,-0.029011,-0.029953,-0.030895,-0.031836,-0.032779,-0.033721,-0.034663,-0.035606,-0.036549,-0.037492,-0.038436,-0.039379,-0.040323,-0.041267,-0.042211,-0.043156,-0.044100,-0.045045,-0.045990,-0.046935,-0.047881,-0.048827,-0.049772,-0.050718,-0.051665,-0.052611,-0.053558,-0.054504,-0.055451,-0.056398,-0.057346,-0.058293,-0.059241,-0.060189,-0.061137,-0.062085,-0.063034,-0.063982,-0.064931,-0.065880,-0.066829,-0.067778,-0.068728,-0.069677,-0.070627,-0.071577,-0.072527,-0.073478,-0.074428,-0.075379,-0.076330,-0.077280,-0.078232,-0.079183,-0.080134,-0.081086,-0.063555,-0.046950,-0.031223,-0.016332,-0.002234,0.011110,0.023738,0.035686,0.046988,0.057675,0.067780,0.077330,0.086354,0.094879,0.102928,0.110525,0.117694,0.124456,0.130831,0.136838,0.142496,0.147823,0.152834,0.157546,0.161973,0.166130,0.170031,0.173688,0.177113,0.180317,0.183313,0.186111,0.188719,0.191148,0.193407,0.195505,0.197448,0.199246,0.200904,0.202431,0.203833,0.207383,0.210757,0.213962,0.217005,0.219895,0.222636,0.225235,0.227699,0.230034,0.232244,0.234335,0.236313,0.238183,0.239948,0.241613,0.243184,0.244663,0.246055,0.247363,0.248592,0.249744,0.250823,0.251831,0.252773,0.253650,0.254466,0.255223,0.255924,0.256570,0.257165,0.257710,0.258208,0.258660,0.259069,0.259436,0.259762,0.260050,0.260301,0.260517,0.260699,0.260849,0.260967,0.261055,0.261114,0.261146,0.261151,0.261130,0.261086,0.261017,0.260926,0.260813,0.260679,0.260525,0.260352,0.260160,0.259950,0.259722,0.259478,0.259218,0.258943,0.258653,0.258348,0.258029,0.257697,0.257352,0.256995,0.256626,0.256245,0.255852,0.255449,0.255036,0.254612,0.254179,0.253735,0.253283,0.252822,0.252352,0.251874,0.251388,0.250894,0.250392,0.249883,0.249367,0.248844,0.248314,0.247777,0.247234,0.246685,0.246130,0.245569,0.245002,0.244430,0.243852,0.243269,0.242680,0.242087,0.241489,0.240886,0.240278,0.239666,0.239050,0.238429,0.237804,0.237174,0.236541,0.235904,0.235262,0.234617,0.233969,0.233316,0.232660,0.232001,0.231338,0.230672,0.230003,0.229330,0.228654,0.227975,0.227293,0.226608,0.225921,0.225230,0.224536,0.223840,0.223141,0.222439,0.221735,0.221028,0.220318,0.219606,0.218891,0.218174,0.217455,0.216733,0.216009,0.215283,0.214554,0.213823,0.213090,0.212355,0.211618,0.210879,0.210137,0.209394,0.208648,0.207900,0.207151,0.206400,0.205646,0.204891,0.204134,0.203375,0.202614,0.201852,0.201087,0.200321,0.199554,0.198784,0.198013,0.197240,0.196466,0.195690,0.194912,0.194133,0.193352,0.192569,0.191785,0.191000,0.190213,0.189424,0.188634,0.187843,0.187050,0.186256,0.185460,0.184663,0.183864,0.183064,0.182263,0.181461,0.180657,0.179852,0.179045,0.178237,0.177428,0.176618,0.175806,0.174993,0.174179,0.173364,0.172548,0.171730,0.170911,0.170091,0.169270,0.168448,0.167624,0.166800,0.165974,0.165147,0.164319,0.163490,0.162660,0.161829,0.160997,0.160164,0.159329,0.158494,0.157658,0.156820,0.155982,0.155143,0.154302,0.153461,0.152619,0.151776,0.150931,0.150086,0.149240,0.148393,0.147545,0.146697,0.145847,0.144996,0.144145,0.143292,0.142439,0.141585,0.140730,0.139874,0.139017,0.138160,0.137301,0.136442,0.135582,0.134721,0.133860,0.132997,0.132134,0.131270,0.130405,0.129540,0.128673,0.127806,0.126938,0.126070,0.125200,0.124330,0.123460,0.122588,0.121716,0.120843,0.119969,0.119095,0.118220,0.117344,0.116467,0.115590,0.114712,0.113834,0.112955,0.112075,0.111194,0.110313,0.109431,0.108549,0.107666,0.106782,0.105898,0.105013,0.104127,0.103241,0.102354,0.101467,0.100579,0.099690,0.098801,0.097911,0.097021,0.096130,0.095238,0.094346,0.093454,0.092560,0.091667,0.090772,0.089877,0.088982,0.088086,0.087190,0.086293,0.085395,0.084497,0.083598,0.082699,0.081800,0.080899,0.079999,0.079098,0.078196,0.077294,0.076391,0.075488,0.074584,0.073680,0.072776,0.071871,0.070965,0.070059,0.069153,0.068246,0.067338,0.066431,0.065522,0.064614,0.063704,0.062795,0.061885,0.060974,0.060063,0.059152,0.058240,0.057328,0.056415,0.055502,0.054589,0.053675,0.052761,0.051846,0.050931,0.050015,0.049100,0.048183,0.047267,0.046350,0.045432,0.044514,0.043596,0.042678,0.041759,0.040839,0.039920,0.038999,0.038079,0.037158,0.036237,0.035315,0.034394,0.033471,0.032549,0.031626,0.030703,0.029779,0.028855,0.027931,0.027006,0.026081,0.025156,0.024230,0.023304,0.022378,0.021451,0.020524,0.019597,0.018669,0.017741,0.016813,0.015885,0.014956,0.014027,0.013097,0.012168,0.011238,0.010307,0.009377,0.008446,0.007514,0.006583,0.005651,0.004719,0.003787,0.002854,0.001921,0.000988,0.000054,-0.000879,-0.001813,-0.002748,-0.003682,-0.004617,-0.005552,-0.006488,-0.007423,-0.008359,-0.009295,-0.010232,-0.011168,-0.012105,-0.013042,-0.013980,-0.014918,-0.015855,-0.016794,-0.017732,-0.018671,-0.019610,-0.020549,-0.021488,-0.022428,-0.023368,-0.024308,-0.025248,-0.026188,-0.027129,-0.028070,-0.029011,-0.029953,-0.030895,-0.031836,-0.032779,-0.033721,-0.034663,-0.035606,-0.036549,-0.037492,-0.038436,-0.039379,-0.040323,-0.041267,-0.042211,-0.043156,-0.044100,-0.045045,-0.045990,-0.046935,-0.047881,-0.048827,-0.049772,-0.050718,-0.051665,-0.053305,-0.054738,-0.055980,-0.057042,-0.057938,-0.058679,-0.059275,-0.059737,-0.060073,-0.060292,-0.060402,-0.060410,-0.060325,-0.060151,-0.059895,-0.059562,-0.059159,-0.058690,-0.058159,-0.057571,-0.056930,-0.056239,-0.055502,-0.054723,-0.053905,-0.053049,-0.052160,-0.051238,-0.050288,-0.049311,-0.048308,-0.047282,-0.046235,-0.045167,-0.044082,-0.042979,-0.041860,-0.040727,-0.039581,-0.038422,-0.037252,-0.036071,-0.034880,-0.033680,-0.032472,-0.031255,-0.030032,-0.028802,-0.027565,-0.026322,-0.025074,0};
const float PDSawLUT[] = {0.000248,-0.000447,-0.001176,-0.001876,-0.002599,-0.003271,-0.003971,-0.004643,-0.005344,-0.006067,-0.006795,-0.007547,-0.008247,-0.008947,-0.009647,-0.010371,-0.011098,-0.011799,-0.012522,-0.013250,-0.013978,-0.014702,-0.015457,-0.016158,-0.016909,-0.017608,-0.018310,-0.019060,-0.019789,-0.020544,-0.021267,-0.021967,-0.022696,-0.023447,-0.024203,-0.024954,-0.025682,-0.026408,-0.027105,-0.027860,-0.028589,-0.029340,-0.030096,-0.030847,-0.031602,-0.032330,-0.033081,-0.033837,-0.034588,-0.035343,-0.036072,-0.036850,-0.037607,-0.038385,-0.039140,-0.039890,-0.040617,-0.041346,-0.042098,-0.042880,-0.043639,-0.044443,-0.045198,-0.045727,-0.046478,-0.047235,-0.048016,-0.048825,-0.049602,-0.050359,-0.051136,-0.051893,-0.052676,-0.053455,-0.054236,-0.054990,-0.055799,-0.056578,-0.057361,-0.058137,-0.058894,-0.059673,-0.060455,-0.061234,-0.062019,-0.062823,-0.063606,-0.064384,-0.065169,-0.065974,-0.066759,-0.067560,-0.068317,-0.069095,-0.069877,-0.070658,-0.071469,-0.072275,-0.073086,-0.073892,-0.074700,-0.075481,-0.076284,-0.077069,-0.077873,-0.078660,-0.079492,-0.080299,-0.081080,-0.081893,-0.082725,-0.083535,-0.084341,-0.085147,-0.085960,-0.086795,-0.087634,-0.088464,-0.089267,-0.090052,-0.090858,-0.091668,-0.092477,-0.093315,-0.094149,-0.094980,-0.095790,-0.096599,-0.097434,-0.098243,-0.099074,-0.099890,-0.100749,-0.101580,-0.102389,-0.103198,-0.104036,-0.104867,-0.105680,-0.106513,-0.107348,-0.108189,-0.109043,-0.109857,-0.110723,-0.111581,-0.112415,-0.113253,-0.114086,-0.114920,-0.115758,-0.116592,-0.117425,-0.118234,-0.119072,-0.119938,-0.120795,-0.121634,-0.122500,-0.123357,-0.124199,-0.125086,-0.125952,-0.126813,-0.127671,-0.128513,-0.129375,-0.130237,-0.131103,-0.131964,-0.132822,-0.133664,-0.134520,-0.135358,-0.136225,-0.137115,-0.137971,-0.138805,-0.139641,-0.140484,-0.141375,-0.142269,-0.143154,-0.144016,-0.144878,-0.145743,-0.146610,-0.147500,-0.148386,-0.149246,-0.150078,-0.150845,-0.151764,-0.152672,-0.153534,-0.154399,-0.155260,-0.156127,-0.157018,-0.157917,-0.158831,-0.159720,-0.160616,-0.161524,-0.162395,-0.163285,-0.164181,-0.165094,-0.165984,-0.166878,-0.167768,-0.168658,-0.169554,-0.170461,-0.171332,-0.172216,-0.173083,-0.173980,-0.174902,-0.175821,-0.176733,-0.177617,-0.178485,-0.179378,-0.180275,-0.181187,-0.182083,-0.182996,-0.183896,-0.184808,-0.185711,-0.186652,-0.187564,-0.188461,-0.189377,-0.190260,-0.191141,-0.192081,-0.193000,-0.193913,-0.194813,-0.195718,-0.196599,-0.197540,-0.198465,-0.199413,-0.200360,-0.201295,-0.202195,-0.203114,-0.204039,-0.204972,-0.205869,-0.206782,-0.207689,-0.208629,0.209562,0.208571,0.207544,0.206523,0.205475,0.204463,0.203439,0.202419,0.201370,0.200364,0.199351,0.198324,0.197318,0.196313,0.195307,0.194295,0.193256,0.192208,0.191194,0.190167,0.189162,0.188156,0.187150,0.186137,0.185103,0.184080,0.183074,0.182077,0.181084,0.180066,0.179073,0.178046,0.177049,0.176072,0.175087,0.174082,0.173076,0.172070,0.171073,0.170088,0.169084,0.168082,0.167076,0.166070,0.165073,0.164088,0.163099,0.162135,0.161138,0.160152,0.159147,0.158150,0.157164,0.156159,0.155153,0.154147,0.153142,0.152154,0.151197,0.150230,0.149264,0.148268,0.147282,0.146256,0.145272,0.144287,0.143319,0.142334,0.141366,0.140381,0.139430,0.138473,0.137487,0.136491,0.135514,0.134538,0.133561,0.132585,0.131608,0.130631,0.129647,0.128654,0.127686,0.126735,0.125787,0.124830,0.123863,0.122906,0.121930,0.120953,0.119977,0.119010,0.118043,0.117057,0.116099,0.115133,0.114195,0.113267,0.112310,0.111333,0.110367,0.109409,0.108443,0.107485,0.106508,0.105542,0.104584,0.103618,0.102679,0.101747,0.100800,0.099842,0.098866,0.097899,0.096941,0.095986,0.095057,0.094099,0.093133,0.092196,0.091267,0.090309,0.089354,0.088423,0.087473,0.086547,0.085668,0.084808,0.083935,0.083021,0.082062,0.081097,0.080149,0.079213,0.078283,0.077347,0.076417,0.075470,0.074532,0.073610,0.072703,0.071780,0.070826,0.069885,0.068920,0.067972,0.067047,0.066145,0.065223,0.064293,0.063334,0.062381,0.061462,0.060555,0.059654,0.058722,0.057783,0.056853,0.055917,0.054999,0.054080,0.053150,0.052214,0.051294,0.050360,0.049425,0.048506,0.047587,0.046657,0.045721,0.044803,0.043882,0.042961,0.042042,0.041124,0.040193,0.039270,0.038355,0.037430,0.036526,0.035607,0.034701,0.033786,0.032851,0.031932,0.031012,0.030090,0.029184,0.028282,0.027376,0.026471,0.025665,0.024759,0.023870,0.022965,0.022043,0.021125,0.020206,0.019300,0.018397,0.017489,0.016584,0.015678,0.014775,0.013856,0.012938,0.012017,0.011095,0.010190,0.009300,0.008410,0.007517,0.006638,0.005751,0.004832,0.003926,0.003034,0.002128,0.001222,0.000332,-0.000571,-0.001479,-0.002371,-0.003261,-0.004152,-0.005042,-0.005934,-0.006827,-0.007703,-0.008578,-0.009471,-0.010363,-0.011267,-0.012172,-0.013063,-0.013955,-0.014862,-0.015767,-0.016657,-0.017547,-0.018426,-0.019304,-0.020180,-0.021056,-0.021948,-0.022841,-0.023717,-0.024593,-0.025471,-0.026350,-0.027240,-0.028145,-0.029049,-0.029942,-0.030821,-0.031682,-0.032642,-0.033540,-0.034444,-0.035278,-0.036225,-0.037099,-0.037911,-0.038815,-0.039647,-0.040587,-0.041478,-0.042382,-0.043242,-0.044111,-0.044972,-0.045834,-0.046694,-0.047535,-0.048468,-0.049359,-0.050247,-0.051145,-0.052049,-0.052911,-0.053771,-0.054640,-0.055489,-0.056393,-0.057239,-0.058164,-0.058984,-0.059844,-0.060700,-0.061590,-0.062508,-0.063313,-0.064237,-0.065044,-0.065946,-0.066789,-0.067734,-0.068597,-0.069457,-0.070339,-0.071147,-0.072051,-0.072911,-0.073780,-0.074642,-0.075503,-0.076372,-0.077234,-0.078097,-0.078957,-0.079814,-0.080730,-0.081549,-0.082406,-0.083297,-0.084201,-0.085086,-0.085886,-0.086718,-0.087433,-0.088283,-0.089172,-0.090082,-0.090932,-0.091848,-0.092668,-0.093538,-0.094400,-0.095249,-0.096171,-0.096993,-0.097854,-0.098723,-0.099586,-0.100461,-0.101281,-0.102163,-0.102985,-0.103846,-0.104728,-0.105562,-0.106394,-0.107224,-0.108087,-0.108948,-0.109817,-0.110680,-0.111541,-0.112423,-0.113257,-0.114078,-0.114959,-0.115783,-0.116655,-0.117485,-0.118359,-0.119181,-0.120051,-0.120925,-0.121746,-0.122616,-0.123479,-0.124342,-0.125215,-0.126056,-0.126880,-0.127741,-0.128611,-0.129485,-0.130329,-0.131132,-0.131954,-0.132823,-0.133687,-0.134561,-0.135383,-0.136264,-0.137097,-0.137928,-0.138813,-0.139596,-0.140487,-0.141273,-0.142125,-0.143026,-0.143906,-0.144740,-0.145581,-0.146406,-0.147278,-0.148120,-0.148955,-0.149788,-0.150630,-0.151465,-0.152299,-0.153130,-0.154004,-0.154827,-0.155707,-0.156543,-0.157376,-0.158208,-0.159071,-0.159943,-0.160775,-0.161649,-0.162482,-0.163324,-0.164158,-0.164999,-0.165825,-0.166697,-0.167539,-0.168364,-0.169226,-0.170106,-0.170942,-0.171785,-0.172589,-0.173425,-0.174258,-0.175100,-0.175934,-0.176776,-0.177612,-0.178446,-0.179287,-0.180123,-0.180957,-0.181790,-0.182663,-0.183497,-0.184329,-0.185202,-0.186046,-0.186841,-0.187705,-0.188576,-0.189418,-0.190252,-0.191094,-0.191930,-0.192764,-0.193606,-0.194442,-0.195276,-0.196007,-0.196927,-0.197985,-0.198889,-0.198864,-0.196590,-0.190038,-0.177823,-0.159327,-0.135317,-0.107535,-0.078439,-0.049884,-0.024562,-0.005293,0.003988,0.002742,-0.002668,-0.007102,-0.009523,-0.011196,-0.013868,-0.017432,-0.021250,-0.024410,-0.027035,-0.029612,-0.032544,-0.035633,-0.038522,-0.041257,-0.043765,-0.046398,-0.048983,-0.051629,-0.054188,-0.056649,-0.059103,-0.061436,-0.063885,-0.066328,-0.068684,-0.071036,-0.073293,-0.075611,-0.077851,-0.080077,-0.082287,-0.084484,-0.086742,-0.088857,-0.091020,-0.093171,-0.095299,-0.097486,-0.099605,-0.101725,-0.103779,-0.105847,-0.107842,-0.109831,-0.111801,-0.113816,-0.115822,-0.117886,0.119818,0.119914,0.119899,0.119888,0.119852,0.119871,0.119834,0.119790,0.119760,0.119658,0.119610,0.119498,0.119438,0.119384,0.119211,0.119147,0.119015,0.118933,0.118801,0.118673,0.118542,0.118353,0.118222,0.118027,0.117881,0.117695,0.117498,0.117298,0.117140,0.116917,0.116803,0.116584,0.116427,0.116132,0.115912,0.115697,0.115480,0.115217,0.114953,0.114727,0.114458,0.114221,0.113996,0.113686,0.113408,0.113136,0.112853,0.112577,0.112284,0.112057,0.111687,0.111409,0.111082,0.110755,0.110465,0.110140,0.109807,0.109474,0.109176,0.108846,0.108506,0.108179,0.107798,0.108067,0.107721,0.107380,0.107031,0.106694,0.106304,0.105964,0.105578,0.105198,0.104811,0.104464,0.104043,0.103659,0.103271,0.102854,0.102422,0.102033,0.101649,0.101215,0.100822,0.100430,0.100035,0.099608,0.099182,0.098748,0.098319,0.097891,0.097454,0.097028,0.096562,0.096128,0.095659,0.095226,0.094780,0.094384,0.093922,0.093416,0.092981,0.092473,0.092034,0.091595,0.091153,0.090682,0.090215,0.089704,0.089260,0.088791,0.088282,0.087813,0.087302,0.086792,0.086312,0.085874,0.085361,0.084854,0.084346,0.083838,0.083326,0.082844,0.082334,0.081824,0.081314,0.080799,0.080321,0.079808,0.079263,0.078754,0.078208,0.077694,0.077181,0.076665,0.076122,0.075574,0.075062,0.074514,0.074002,0.073456,0.072914,0.072336,0.071785,0.071238,0.070695,0.070116,0.069568,0.069021,0.068470,0.067957,0.067376,0.066831,0.066250,0.065696,0.065149,0.064568,0.064021,0.063439,0.062892,0.062315,0.061704,0.061127,0.060516,0.059933,0.059386,0.058772,0.058225,0.057611,0.057063,0.056451,0.055872,0.055259,0.054680,0.054069,0.053457,0.052877,0.052268,0.051626,0.051013,0.050430,0.049849,0.049238,0.048626,0.048016,0.047375,0.046736,0.046153,0.045565,0.044958,0.044347,0.043706,0.043427,0.042816,0.042174,0.041531,0.040918,0.040304,0.039691,0.039079,0.038436,0.037825,0.037156,0.036546,0.035875,0.035203,0.034561,0.033917,0.033304,0.032666,0.032024,0.031381,0.030740,0.030068,0.029426,0.028753,0.028117,0.027445,0.026774,0.026103,0.025432,0.024760,0.024092,0.023479,0.022806,0.022164,0.021492,0.020821,0.020155,0.019454,0.018782,0.018111,0.017439,0.016771,0.016128,0.015457,0.014785,0.014113,0.013418,0.012718,0.012046,0.011374,0.010679,0.010007,0.009335,0.008635,0.007935,0.007240,0.006511,0.005839,0.005168,0.004472,0.003800,0.003100,0.002372,0.001676,0.000977};
const float PDWave3LUT[] = {0.005028,0.005354,0.004452,0.003453,0.002683,0.001968,0.001094,0.000014,-0.001066,-0.002093,-0.003046,-0.004023,-0.005052,-0.006108,-0.007159,-0.008136,-0.009140,-0.010146,-0.011173,-0.012174,-0.013201,-0.014206,-0.015207,-0.016239,-0.017266,-0.018243,-0.019244,-0.020249,-0.021276,-0.022282,-0.023309,-0.024310,-0.025337,-0.026343,-0.027369,-0.028347,-0.029351,-0.030352,-0.031380,-0.032384,-0.033384,-0.034390,-0.035417,-0.036422,-0.037422,-0.038428,-0.039453,-0.040431,-0.041431,-0.042437,-0.043463,-0.044442,-0.045469,-0.046473,-0.047473,-0.048477,-0.049456,-0.050484,-0.051511,-0.052515,-0.053514,-0.054492,-0.055495,-0.056473,-0.057475,-0.058506,-0.059506,-0.060511,-0.061511,-0.062515,-0.063518,-0.064548,-0.065547,-0.066553,-0.067555,-0.068579,-0.069558,-0.070562,-0.071563,-0.072565,-0.073546,-0.074572,-0.075576,-0.076574,-0.077553,-0.078558,-0.079558,-0.080563,-0.081567,-0.082567,-0.083572,-0.084572,-0.085576,-0.086574,-0.087555,-0.088579,-0.089558,-0.090563,-0.091565,-0.092543,-0.093544,-0.094548,-0.095549,-0.096553,-0.097553,-0.098555,-0.099537,-0.100563,-0.101564,-0.102543,-0.103541,-0.104521,-0.105525,-0.106522,-0.107504,-0.108527,-0.109506,-0.110508,-0.111488,-0.112492,-0.113492,-0.114500,-0.115522,-0.116501,-0.117502,-0.118503,-0.119480,-0.120460,-0.121467,-0.122489,-0.123468,-0.124469,-0.125470,-0.126450,-0.127450,-0.128451,-0.129431,-0.130432,-0.131436,-0.132437,-0.133417,-0.134414,-0.135394,-0.136398,-0.137395,-0.138379,-0.139399,-0.140380,-0.141381,-0.142361,-0.143362,-0.144342,-0.145343,-0.146347,-0.147347,-0.148348,-0.149324,-0.150304,-0.151305,-0.152305,-0.153286,-0.154286,-0.155287,-0.156268,-0.157268,-0.158248,-0.159249,-0.160249,-0.161226,-0.162206,-0.163202,-0.164183,-0.165187,-0.166188,-0.167193,-0.168193,-0.169173,-0.170169,-0.171151,-0.172150,-0.173127,-0.174108,-0.175109,-0.176108,-0.177089,-0.178090,-0.179089,-0.180070,-0.181066,-0.182042,-0.183024,-0.184024,-0.185005,-0.186009,-0.187010,-0.188010,-0.188991,-0.189986,-0.190963,-0.191945,-0.192944,-0.193925,-0.194926,-0.195925,-0.196902,-0.197884,-0.198887,-0.199883,-0.200865,-0.201864,-0.202845,-0.203840,-0.204823,-0.205822,-0.206803,-0.207798,-0.208775,-0.209757,-0.210761,-0.211756,-0.212739,-0.213737,-0.214714,-0.215696,-0.216689,-0.217655,-0.218678,-0.219676,-0.220658,-0.221653,-0.222629,-0.223606,-0.224589,-0.225592,-0.226593,-0.227592,-0.228575,-0.229573,-0.230549,-0.231526,-0.232503,-0.233485,-0.234486,-0.235484,-0.236460,-0.237442,-0.238437,-0.239420,-0.240418,-0.241400,-0.242395,-0.243378,-0.244376,-0.245352,-0.246335,-0.247329,0.248312,0.247357,0.246387,0.245432,0.244455,0.243479,0.242508,0.241549,0.240573,0.239603,0.238654,0.237694,0.236718,0.235741,0.234772,0.233816,0.232840,0.231863,0.230886,0.229910,0.228940,0.227980,0.227011,0.226063,0.225107,0.224130,0.223154,0.222183,0.221224,0.220247,0.219279,0.218329,0.217369,0.216400,0.215436,0.214439,0.213471,0.212514,0.211538,0.210568,0.209616,0.208660,0.207683,0.206706,0.205737,0.204770,0.203784,0.202832,0.201875,0.200907,0.199942,0.198945,0.197977,0.197020,0.196044,0.195074,0.194114,0.193138,0.192170,0.191213,0.190236,0.189267,0.188306,0.187338,0.186372,0.185385,0.184428,0.183452,0.182482,0.181522,0.180545,0.179569,0.178601,0.177644,0.176676,0.175719,0.174742,0.173765,0.172789,0.171812,0.170836,0.169867,0.168906,0.167939,0.166972,0.165986,0.165028,0.164059,0.163090,0.162116,0.161164,0.160178,0.159220,0.158243,0.157267,0.156298,0.155337,0.154361,0.153384,0.152417,0.151449,0.150464,0.149506,0.148538,0.147568,0.146584,0.145623,0.144646,0.143670,0.142750,0.141773,0.140796,0.139820,0.138843,0.137867,0.136899,0.135937,0.134960,0.133984,0.133007,0.132031,0.131054,0.130088,0.129129,0.128153,0.127176,0.126208,0.125246,0.124270,0.123293,0.122317,0.121351,0.120392,0.119415,0.118438,0.117471,0.116509,0.115532,0.114556,0.113590,0.112631,0.111654,0.110677,0.109701,0.108724,0.107748,0.106771,0.105806,0.104846,0.103870,0.102902,0.101931,0.100949,0.099987,0.099010,0.098045,0.097085,0.096097,0.095115,0.094155,0.093179,0.092212,0.091249,0.090273,0.089296,0.088320,0.087343,0.086366,0.085401,0.084441,0.083465,0.082498,0.081535,0.080558,0.079572,0.078592,0.077629,0.076652,0.075676,0.074711,0.073751,0.072774,0.071798,0.070831,0.069868,0.068891,0.067915,0.066928,0.065948,0.064985,0.064008,0.063032,0.062055,0.061091,0.060130,0.059154,0.058177,0.057201,0.056224,0.055247,0.054283,0.053322,0.052346,0.051369,0.050393,0.049416,0.048440,0.047463,0.046497,0.045533,0.044557,0.043580,0.042604,0.041627,0.040651,0.039687,0.038725,0.037749,0.036772,0.035796,0.034819,0.033843,0.032877,0.031902,0.030924,0.029960,0.028996,0.028022,0.027030,0.026054,0.025077,0.024114,0.023152,0.022175,0.021199,0.020233,0.019258,0.018280,0.017305,0.016327,0.015363,0.014400,0.013424,0.012433,0.011457,0.010480,0.009503,0.008527,0.007564,0.006588,0.005597,0.004635,0.003672,0.002696,0.001719,0.000743,-0.000234,-0.001211,-0.002187,-0.003178,-0.004098,-0.005131,-0.006065,-0.007042,-0.008018,-0.008995,-0.009972,-0.010960,-0.011901,-0.012878,-0.013854,-0.014831,-0.015808,-0.016784,-0.017761,-0.018737,-0.019714,-0.020690,-0.021680,-0.022615,-0.023592,-0.024569,-0.025545,-0.026522,-0.027498,-0.028475,-0.029451,-0.030428,-0.031404,-0.032381,-0.033358,-0.034345,-0.035287,-0.036264,-0.037240,-0.038217,-0.039194,-0.040170,-0.041147,-0.042136,-0.043072,-0.044035,-0.045053,-0.046042,-0.046978,-0.047955,-0.048931,-0.049895,-0.050912,-0.051889,-0.052878,-0.053814,-0.054790,-0.055777,-0.056720,-0.057697,-0.058673,-0.059650,-0.060616,-0.061637,-0.062569,-0.063590,-0.064533,-0.065509,-0.066486,-0.067452,-0.068472,-0.069416,-0.070392,-0.071369,-0.072345,-0.073322,-0.074298,-0.075287,-0.076223,-0.077200,-0.078176,-0.079153,-0.080118,-0.081146,-0.082083,-0.083059,-0.084046,-0.084979,-0.085989,-0.086966,-0.087952,-0.088895,-0.089862,-0.090872,-0.091848,-0.092825,-0.093811,-0.094755,-0.095731,-0.096708,-0.097684,-0.098661,-0.099628,-0.100637,-0.101614,-0.102591,-0.103567,-0.104553,-0.105497,-0.106464,-0.107483,-0.108427,-0.109403,-0.110380,-0.111356,-0.112333,-0.113309,-0.114286,-0.115262,-0.116239,-0.117226,-0.118164,-0.119141,-0.120117,-0.121083,-0.122098,-0.123075,-0.124062,-0.125000,-0.125966,-0.126981,-0.127958,-0.128945,-0.129883,-0.130859,-0.131836,-0.132813,-0.133789,-0.134766,-0.135742,-0.136719,-0.137705,-0.138634,-0.139648,-0.140625,-0.141602,-0.142578,-0.143565,-0.144503,-0.145480,-0.146456,-0.147433,-0.148409,-0.149376,-0.150391,-0.151377,-0.152316,-0.153292,-0.154269,-0.155236,-0.156250,-0.157236,-0.158175,-0.159142,-0.160156,-0.161133,-0.162109,-0.163095,-0.164034,-0.165011,-0.165988,-0.166964,-0.167941,-0.168917,-0.169894,-0.170870,-0.171847,-0.172823,-0.173800,-0.174777,-0.175753,-0.176730,-0.177706,-0.178683,-0.179667,-0.180605,-0.181613,-0.182589,-0.183566,-0.184542,-0.185519,-0.186495,-0.187472,-0.188448,-0.189425,-0.190409,-0.191355,-0.192331,-0.193308,-0.194277,-0.195284,-0.196268,-0.197207,-0.198214,-0.199191,-0.200159,-0.201180,-0.202120,-0.203097,-0.204073,-0.205050,-0.206027,-0.207003,-0.207980,-0.208963,-0.209903,-0.210909,-0.211886,-0.212863,-0.213846,-0.214786,-0.215792,-0.216769,-0.217752,-0.218699,-0.219669,-0.220675,-0.221658,-0.222605,-0.223581,-0.224558,-0.225534,-0.226505,-0.227511,-0.228494,-0.229441,-0.230417,-0.231394,-0.232370,-0.233347,-0.234324,-0.235300,-0.236270,-0.237277,-0.238259,-0.239206,-0.240183,-0.241167,-0.242101,-0.243113,-0.244089,-0.245066,-0.246042,-0.247019,-0.247995,-0.248966,0.249978,0.248972,0.247995,0.247026,0.246007,0.245066,0.244089,0.243113,0.242136,0.241159,0.240177,0.239230,0.238253,0.237282,0.236277,0.235295,0.234352,0.233347,0.232370,0.231394,0.230424,0.229406,0.228464,0.227482,0.226534,0.225558,0.224587,0.223588,0.222570,0.221628,0.220652,0.219675,0.218699,0.217722,0.216740,0.215797,0.214792,0.213816,0.212839,0.211863,0.210886,0.209909,0.208933,0.207956,0.206980,0.206003,0.205027,0.204050,0.203074,0.202097,0.201120,0.200144,0.199167,0.198191,0.197214,0.196238,0.195261,0.194284,0.193303,0.192355,0.191378,0.190406,0.189402,0.188430,0.187415,0.186472,0.185495,0.184519,0.183542,0.182566,0.181589,0.180608,0.179664,0.178659,0.177683,0.176706,0.175726,0.174777,0.173804,0.172800,0.171824,0.170852,0.169838,0.168894,0.167913,0.166968,0.165964,0.164988,0.164011,0.163034,0.162058,0.161081,0.160105,0.159128,0.158152,0.157175,0.156199,0.155222,0.154242,0.153292,0.152316,0.151339,0.150363,0.149386,0.148409,0.147433,0.146460,0.145453,0.144507,0.143500,0.142550,0.141573,0.140600,0.139597,0.138620,0.137641,0.136694,0.135691,0.134714,0.133738,0.132758,0.131808,0.130834,0.129828,0.128878,0.127902,0.126925,0.125948,0.124972,0.123995,0.123019,0.122042,0.121066,0.120089,0.119113,0.118136,0.117159,0.116183,0.115206,0.114230,0.113253,0.112277,0.111300,0.110323,0.109347,0.108370,0.107394,0.106417,0.105438,0.104495,0.103488,0.102511,0.101534,0.100560,0.099556,0.098605,0.097628,0.096652,0.095675,0.094701,0.093696,0.092748,0.091743,0.090792,0.089816,0.088839,0.087863,0.086886,0.085909,0.084933,0.083956,0.082980,0.082001,0.081055,0.080078,0.079102,0.078127,0.077120,0.076142,0.075195,0.074221,0.073212,0.072238,0.071259,0.070314,0.069306,0.068359,0.067383,0.066408,0.065400,0.064455,0.063448,0.062472,0.061495,0.060519,0.059541,0.058594,0.057617,0.056641,0.055664,0.054688,0.053711,0.052734,0.051758,0.050780,0.049834,0.048828,0.047852,0.046875,0.045898,0.044922,0.043945,0.042970,0.041963,0.041017,0.040011,0.039033,0.038086,0.037109,0.036133,0.035156,0.034180,0.033202,0.032255,0.031279,0.030273,0.029297,0.028320,0.027344,0.026366,0.025419,0.024441,0.023517,0.022567,0.021449,0.019775,0.016492,0.009919,-0.001609,-0.019044,-0.041971,-0.068745,-0.097497,-0.126133,-0.151921,-0.169872,-0.172336,-0.158095,-0.134498,-0.107532,-0.080319,-0.054810,-0.032360,-0.014328,-0.001724,0.000977};
const float PDWave4LUT[] = {0.000594,0.000171,-0.000253,-0.000676,-0.001016,-0.001397,-0.001778,-0.002160,-0.002536,-0.002917,-0.003299,-0.003722,-0.004144,-0.004526,-0.004947,-0.005287,-0.005708,-0.006048,-0.006469,-0.006808,-0.007230,-0.007651,-0.007433,-0.007767,-0.008187,-0.008566,-0.008944,-0.009323,-0.009742,-0.010120,-0.010498,-0.010876,-0.011293,-0.011630,-0.012047,-0.012423,-0.012799,-0.013174,-0.013545,-0.013921,-0.014336,-0.014712,-0.015127,-0.015498,-0.015830,-0.016205,-0.016618,-0.016992,-0.017406,-0.017818,-0.018190,-0.018599,-0.018930,-0.019340,-0.019709,-0.020077,-0.020442,-0.020853,-0.021262,-0.021675,-0.022126,-0.022492,-0.022943,-0.023305,-0.023712,-0.024116,-0.023914,-0.024357,-0.024717,-0.025078,-0.025437,-0.025799,-0.026201,-0.026605,-0.027047,-0.027451,-0.027891,-0.028293,-0.028733,-0.029134,-0.029572,-0.029965,-0.030323,-0.030759,-0.031158,-0.031601,-0.032038,-0.032475,-0.032908,-0.033303,-0.033734,-0.034128,-0.034558,-0.034946,-0.035337,-0.035765,-0.036159,-0.036634,-0.037104,-0.037533,-0.037961,-0.038389,-0.038820,-0.039246,-0.039671,-0.040095,-0.040523,-0.040987,-0.041414,-0.041885,-0.042393,-0.042301,-0.042719,-0.043136,-0.043563,-0.044066,-0.044532,-0.045038,-0.045493,-0.045905,-0.046316,-0.046731,-0.047193,-0.047690,-0.048151,-0.048662,-0.049203,-0.049702,-0.050196,-0.050651,-0.051101,-0.051550,-0.052010,-0.052547,-0.053045,-0.053545,-0.054079,-0.054565,-0.055019,-0.055502,-0.055943,-0.056396,-0.056933,-0.057472,-0.058007,-0.058541,-0.059079,-0.059611,-0.060158,-0.060784,-0.061356,-0.061879,-0.062371,-0.062899,-0.063434,-0.063565,-0.064140,-0.064711,-0.065242,-0.065808,-0.066343,-0.066906,-0.067435,-0.068002,-0.068538,-0.069161,-0.069771,-0.070348,-0.070961,-0.071528,-0.072090,-0.072620,-0.073236,-0.073863,-0.074529,-0.075189,-0.075803,-0.076411,-0.076981,-0.077596,-0.078207,-0.078831,-0.079484,-0.080097,-0.080715,-0.081370,-0.081987,-0.082650,-0.083299,-0.083909,-0.084534,-0.085257,-0.086000,-0.086660,-0.087316,-0.087975,-0.088641,-0.089353,-0.090074,-0.090814,-0.091206,-0.091869,-0.092588,-0.093326,-0.094003,-0.094754,-0.095458,-0.096178,-0.096939,-0.097707,-0.098500,-0.099217,-0.099962,-0.100691,-0.101493,-0.102249,-0.103021,-0.103823,-0.104581,-0.105359,-0.106204,-0.106975,-0.107775,-0.108553,-0.109396,-0.110153,-0.110930,-0.111798,-0.112653,-0.113477,-0.114332,-0.115155,-0.116005,-0.116829,-0.117708,-0.118617,-0.119509,-0.120498,-0.121530,-0.122536,-0.123444,-0.124311,-0.125176,-0.126064,-0.126917,-0.127839,-0.128773,-0.129737,-0.130685,-0.131690,-0.132611,-0.133532,-0.134467,-0.135444,-0.136407,-0.137342,0.138318,0.137328,0.136324,0.135389,0.134426,0.133505,0.132569,0.131593,0.130630,0.129709,0.128788,0.127866,0.126945,0.126038,0.125158,0.124241,0.123335,0.122453,0.121546,0.120665,0.119743,0.118852,0.118010,0.117105,0.116242,0.115390,0.114563,0.113696,0.112846,0.112022,0.111185,0.110412,0.109583,0.108885,0.108033,0.107219,0.106423,0.105667,0.104908,0.104148,0.103389,0.102633,0.101872,0.101113,0.100340,0.099541,0.098797,0.098093,0.097384,0.096661,0.095919,0.095193,0.094432,0.093656,0.092872,0.092163,0.091472,0.090816,0.090161,0.089503,0.088831,0.088118,0.087407,0.086697,0.085985,0.085291,0.084629,0.083984,0.083379,0.082755,0.082091,0.081428,0.080767,0.080120,0.079493,0.078845,0.078233,0.077915,0.077265,0.076651,0.076052,0.075473,0.074874,0.074290,0.073691,0.073105,0.072523,0.071972,0.071351,0.070748,0.070177,0.069608,0.069054,0.068531,0.067993,0.067402,0.066794,0.066202,0.065593,0.065036,0.064509,0.063980,0.063453,0.062924,0.062410,0.061913,0.061400,0.060900,0.060348,0.059802,0.059299,0.058779,0.058276,0.057759,0.057252,0.056747,0.056289,0.055782,0.055259,0.054747,0.054225,0.053732,0.053763,0.053285,0.052837,0.052387,0.051937,0.051467,0.050982,0.050529,0.050058,0.049574,0.049117,0.048640,0.048136,0.047579,0.046914,0.046596,0.047963,0.053855,0.069703,0.101064,0.148962,0.209380,0.273073,0.300706,0.248008,0.177800,0.114002,0.066676,0.043123,0.037952,0.036427,0.035269,0.032930,0.029911,0.029565,0.030139,0.029693,0.029078,0.028379,0.027948,0.028104,0.028328,0.027962,0.027141,0.027028,0.026929,0.026664,0.026177,0.025628,0.025183,0.024880,0.024612,0.024280,0.023852,0.023408,0.023018,0.022668,0.022331,0.021939,0.021565,0.021197,0.020821,0.020452,0.020075,0.019685,0.019282,0.018928,0.018574,0.018219,0.017863,0.017506,0.017149,0.016791,0.016452,0.016119,0.015762,0.015382,0.014996,0.014615,0.014228,0.013846,0.013478,0.013138,0.012793,0.012470,0.012148,0.011807,0.011443,0.011075,0.011334,0.011008,0.010662,0.010292,0.009941,0.009635,0.009333,0.009004,0.008654,0.008281,0.007928,0.007598,0.007269,0.006919,0.006585,0.006275,0.005942,0.005609,0.005276,0.004924,0.004570,0.004235,0.003880,0.003543,0.003210,0.002875,0.002543,0.002205,0.001890,0.001554,0.001237,0.000945,0.000611,0.000252,-0.000086,-0.000424,-0.000762,-0.001100,-0.001437,-0.001752,-0.002090,-0.002471,-0.002831,-0.003170,-0.002891,-0.003865,-0.004162,-0.004438,-0.004777,-0.005118,-0.005430,-0.005832,-0.006192,-0.006469,-0.006808,-0.007127,-0.007552,-0.007821,-0.008181,-0.008457,-0.008816,-0.009115,-0.009384,-0.009703,-0.010124,-0.010400,-0.010758,-0.011036,-0.011347,-0.011727,-0.012127,-0.012464,-0.012801,-0.013158,-0.013435,-0.013744,-0.014143,-0.014459,-0.014876,-0.015149,-0.015506,-0.015772,-0.016126,-0.016378,-0.016755,-0.017150,-0.017483,-0.017838,-0.018101,-0.017811,-0.018185,-0.018559,-0.018932,-0.019324,-0.019675,-0.019935,-0.020263,-0.020572,-0.020923,-0.021316,-0.021753,-0.022289,-0.022701,-0.023151,-0.023475,-0.023799,-0.024104,-0.024489,-0.024814,-0.025128,-0.025430,-0.025794,-0.026176,-0.026476,-0.026820,-0.027243,-0.027585,-0.028008,-0.028367,-0.028707,-0.029149,-0.029418,-0.029819,-0.030238,-0.030593,-0.030948,-0.031302,-0.031655,-0.031971,-0.032429,-0.032843,-0.033175,-0.033587,-0.033917,-0.033681,-0.034090,-0.034417,-0.034806,-0.035195,-0.035564,-0.035996,-0.036464,-0.036804,-0.037125,-0.037509,-0.037855,-0.038346,-0.038772,-0.039216,-0.039577,-0.040001,-0.040425,-0.040829,-0.041333,-0.041726,-0.042036,-0.042409,-0.042743,-0.043213,-0.043676,-0.044156,-0.044588,-0.044956,-0.045304,-0.045698,-0.046155,-0.046592,-0.047120,-0.047575,-0.048047,-0.048454,-0.048841,-0.049293,-0.049743,-0.050174,-0.050695,-0.051143,-0.051608,-0.051458,-0.051882,-0.052399,-0.052841,-0.053265,-0.053736,-0.054270,-0.054831,-0.055299,-0.055849,-0.056323,-0.056874,-0.057374,-0.057790,-0.058269,-0.058739,-0.059268,-0.059793,-0.060328,-0.060854,-0.061397,-0.061852,-0.062401,-0.062874,-0.063346,-0.063781,-0.064359,-0.064926,-0.065520,-0.066038,-0.066536,-0.067110,-0.067676,-0.068240,-0.068829,-0.069325,-0.069886,-0.070439,-0.071067,-0.071635,-0.072196,-0.072753,-0.073303,-0.073927,-0.074475,-0.074669,-0.075276,-0.075880,-0.076477,-0.077132,-0.077814,-0.078433,-0.078975,-0.079575,-0.080168,-0.080804,-0.081535,-0.082203,-0.082810,-0.083408,-0.083981,-0.084683,-0.085409,-0.086051,-0.086768,-0.087425,-0.088072,-0.088712,-0.089411,-0.090135,-0.090773,-0.091471,-0.092163,-0.092915,-0.093690,-0.094381,-0.095132,-0.095907,-0.096596,-0.097347,-0.098121,-0.098809,-0.099559,-0.100300,-0.101127,-0.101902,-0.102564,-0.103390,-0.104148,-0.104730,-0.105469,-0.106281,-0.107068,-0.107965,-0.108688,-0.109553,-0.110420,-0.111293,-0.112087,-0.112967,-0.113761,-0.114643,-0.115429,-0.116293,-0.117158,-0.118008,-0.118943,-0.119807,-0.120673,-0.121530,-0.122379,-0.123300,-0.124205,-0.125211,-0.126046,-0.127037,-0.127957,-0.128892,-0.129727,-0.130718,-0.131624,-0.132601,-0.133563,0.134610,0.133620,0.132727,0.131694,0.130662,0.129615,0.128624,0.127704,0.126784,0.125864,0.124957,0.124037,0.123047,0.122127,0.121193,0.120342,0.119422,0.118487,0.117643,0.116697,0.115902,0.115024,0.114241,0.113281,0.112561,0.111697,0.110832,0.109954,0.109144,0.108354,0.107477,0.106680,0.105802,0.104979,0.104244,0.103434,0.102611,0.101867,0.101052,0.100296,0.099552,0.098739,0.097924,0.097167,0.096398,0.095703,0.095011,0.094253,0.093502,0.092744,0.091984,0.091233,0.090463,0.089768,0.089005,0.088558,0.087913,0.087259,0.086623,0.085914,0.085213,0.084495,0.083839,0.083190,0.082543,0.081820,0.081235,0.080511,0.079915,0.079254,0.078656,0.078003,0.077342,0.076679,0.076069,0.075467,0.074856,0.074252,0.073640,0.073036,0.072422,0.071825,0.071141,0.070585,0.070028,0.069472,0.068854,0.068288,0.067736,0.067117,0.066548,0.065979,0.065468,0.064904,0.064340,0.063761,0.063253,0.062687,0.062105,0.061595,0.061470,0.060949,0.060429,0.059901,0.059378,0.058862,0.058268,0.057792,0.057315,0.056846,0.056312,0.055777,0.055296,0.054809,0.054377,0.053894,0.053417,0.052878,0.052386,0.051900,0.051412,0.050918,0.050478,0.050030,0.049594,0.049102,0.048610,0.048118,0.047612,0.047177,0.046616,0.046221,0.045771,0.045309,0.044911,0.044453,0.044052,0.043592,0.043190,0.042734,0.042272,0.041867,0.041392,0.041036,0.041127,0.040768,0.040296,0.039929,0.039511,0.039092,0.038672,0.038256,0.037785,0.037352,0.036980,0.036551,0.036172,0.035792,0.035415,0.034988,0.034556,0.034172,0.033784,0.033448,0.033061,0.032679,0.032246,0.031809,0.031420,0.031030,0.030631,0.030337,0.029941,0.029596,0.029202,0.028803,0.028461,0.028062,0.027713,0.027312,0.026965,0.026516,0.026161,0.025808,0.025404,0.025047,0.024686,0.024374,0.024014,0.024272,0.023862,0.023549,0.023140,0.022782,0.022418,0.022054,0.021689,0.021324,0.020955,0.020630,0.020354,0.019986,0.019620,0.019206,0.018840,0.018515,0.018141,0.017861,0.017490,0.017118,0.016744,0.016415,0.016090,0.015759,0.015429,0.015097,0.014768,0.014391,0.014060,0.013685,0.013314,0.012937,0.012603,0.012269,0.011932,0.011686,0.011312,0.010979,0.010556,0.010219,0.009926,0.009589,0.009294,0.009603,0.009222,0.008885,0.008547,0.008208,0.007918,0.007581,0.007200,0.006819,0.006438,0.006099,0.005802,0.005510,0.005171,0.004833,0.004451,0.004112,0.003730,0.003391,0.003098,0.002803,0.001953,0.000977};
const float PDWave5LUT[] = {0.002996,0.005019,0.007045,0.009074,0.011107,0.013145,0.015191,0.020278,0.022350,0.024432,0.026528,0.028637,0.030761,0.032902,0.035061,0.037239,0.039439,0.041662,0.043910,0.046184,0.048488,0.050822,0.053190,0.059010,0.061495,0.064025,0.066603,0.069234,0.071922,0.074671,0.077488,0.080377,0.083347,0.086405,0.089559,0.092821,0.096201,0.099715,0.103378,0.112215,0.116474,0.121001,0.125851,0.131099,0.136849,0.143264,0.150217,0.149538,0.155373,0.159080,0.156494,0.152900,0.149978,0.147383,0.144327,0.138182,0.135051,0.131985,0.129052,0.126016,0.122975,0.119990,0.117197,0.114451,0.111810,0.109067,0.106428,0.103880,0.101310,0.098820,0.094885,0.092415,0.090016,0.087637,0.085281,0.083001,0.080680,0.078424,0.076134,0.073913,0.071711,0.069515,0.067336,0.065215,0.063066,0.060965,0.057732,0.055661,0.053563,0.051515,0.049474,0.047443,0.045435,0.043508,0.041503,0.039545,0.037555,0.035621,0.033687,0.031759,0.029837,0.027922,0.025135,0.023235,0.021345,0.019502,0.017663,0.015792,0.013997,0.012135,0.010353,0.008545,0.006770,0.004964,0.003196,0.001393,-0.000396,-0.002149,-0.004711,-0.006454,-0.008194,-0.009926,-0.011655,-0.013350,-0.015074,-0.016758,-0.018440,-0.020155,-0.021833,-0.023513,-0.025221,-0.026890,-0.028553,-0.030941,-0.032567,-0.034226,-0.035878,-0.037488,-0.039107,-0.040754,-0.042369,-0.044012,-0.045623,-0.047252,-0.048821,-0.050423,-0.052018,-0.053583,-0.055180,-0.057350,-0.058937,-0.060495,-0.062080,-0.063630,-0.065174,-0.066722,-0.068275,-0.069847,-0.071359,-0.072902,-0.074438,-0.075942,-0.077482,-0.079021,-0.080559,-0.082610,-0.084103,-0.085606,-0.087132,-0.088627,-0.090121,-0.091614,-0.093105,-0.094592,-0.096083,-0.097572,-0.099048,-0.100476,-0.101957,-0.103412,-0.104894,-0.106844,-0.108297,-0.109774,-0.111213,-0.112629,-0.114073,-0.115520,-0.116986,-0.118400,-0.119842,-0.121284,-0.122718,-0.124122,-0.125522,-0.126940,-0.128834,-0.130265,-0.131667,-0.133075,-0.134503,-0.135893,-0.137265,-0.138664,-0.140064,-0.141462,-0.142868,-0.144287,-0.145655,-0.147041,-0.148410,-0.149806,-0.151586,-0.152974,-0.154333,-0.155693,-0.157051,-0.158413,-0.159799,-0.161158,-0.162516,-0.163873,-0.165231,-0.166580,-0.167917,-0.169292,-0.170617,-0.171966,-0.173673,-0.175020,-0.176340,-0.177668,-0.179015,-0.180341,-0.181675,-0.182976,-0.184321,-0.185640,-0.186958,-0.188277,-0.189595,-0.190913,-0.192238,-0.193573,-0.195208,-0.196543,-0.197826,-0.199116,-0.200424,-0.201715,-0.203022,-0.204313,-0.205610,-0.206871,-0.208186,-0.209501,0.210808,0.210127,0.209429,0.209060,0.208387,0.207714,0.207040,0.206363,0.205690,0.205016,0.204343,0.203669,0.202986,0.202288,0.201605,0.200906,0.200222,0.199522,0.198835,0.198403,0.197728,0.197044,0.196336,0.195627,0.194927,0.194233,0.193509,0.192824,0.192105,0.191377,0.190692,0.189982,0.189273,0.188554,0.187820,0.187343,0.186624,0.185900,0.185204,0.184468,0.183745,0.183011,0.182291,0.181547,0.180813,0.180093,0.179349,0.178615,0.177894,0.177150,0.176416,0.175927,0.175171,0.174411,0.173679,0.172922,0.172200,0.171456,0.170711,0.169967,0.169212,0.168444,0.167689,0.166932,0.166199,0.165432,0.164880,0.164125,0.163357,0.162601,0.161823,0.161056,0.160300,0.159532,0.158776,0.158008,0.157252,0.156474,0.155695,0.154917,0.154148,0.153388,0.152807,0.152029,0.151250,0.150471,0.149681,0.148881,0.148102,0.147334,0.146555,0.145733,0.144965,0.144197,0.143396,0.142617,0.141825,0.141022,0.140407,0.139617,0.138816,0.138026,0.137225,0.136434,0.135622,0.134822,0.134043,0.133240,0.132419,0.131628,0.130827,0.130036,0.129236,0.128432,0.127760,0.126959,0.126168,0.125356,0.124544,0.123731,0.122919,0.122107,0.121295,0.120482,0.119670,0.118846,0.118013,0.117188,0.116355,0.115707,0.114895,0.114068,0.113232,0.112408,0.111575,0.110750,0.109917,0.109105,0.108280,0.107447,0.106622,0.105790,0.104964,0.104119,0.103287,0.102593,0.101760,0.100935,0.100089,0.099257,0.098432,0.097586,0.096739,0.095904,0.095065,0.094200,0.093355,0.092523,0.091697,0.090852,0.089993,0.089292,0.088447,0.087602,0.086743,0.085878,0.085033,0.084188,0.083329,0.082478,0.081651,0.080792,0.079928,0.079083,0.078237,0.077378,0.076512,0.075762,0.074903,0.074053,0.073212,0.072334,0.071470,0.070610,0.069732,0.068868,0.068009,0.067145,0.066285,0.065421,0.064561,0.063683,0.062936,0.062058,0.061180,0.060316,0.059456,0.058578,0.057715,0.056840,0.055958,0.055098,0.054235,0.053358,0.052459,0.051581,0.050703,0.049839,0.049045,0.048182,0.047321,0.046443,0.045565,0.044687,0.043809,0.042915,0.042020,0.041141,0.040263,0.039385,0.038492,0.037611,0.036751,0.035857,0.035043,0.034182,0.033288,0.032393,0.031515,0.030637,0.029743,0.028832,0.027937,0.027058,0.026165,0.025267,0.024387,0.023493,0.022598,0.021720,0.020907,0.020013,0.019118,0.018224,0.017313,0.016418,0.015524,0.014629,0.013735,0.012824,0.011913,0.011002,0.010107,0.009229,0.008335,0.007506,0.006497,0.005635,0.004724,0.003813,0.002902,0.001991,0.001064,0.000202,-0.000709,-0.001619,-0.002530,-0.003441,-0.004368,-0.005246,-0.006108,-0.006921,-0.007832,-0.008772,-0.009608,-0.010502,-0.011347,-0.012193,-0.013006,-0.013933,-0.014826,-0.015656,-0.016550,-0.017379,-0.018273,-0.019102,-0.019996,-0.020710,-0.021570,-0.022352,-0.023260,-0.024073,-0.024885,-0.025697,-0.026509,-0.027306,-0.028167,-0.028977,-0.029796,-0.030623,-0.031387,-0.032199,-0.032996,-0.033659,-0.034486,-0.035265,-0.036029,-0.036856,-0.037635,-0.038400,-0.039226,-0.040035,-0.040719,-0.041481,-0.042314,-0.043093,-0.043887,-0.044633,-0.045379,-0.045927,-0.046658,-0.047452,-0.048197,-0.048943,-0.049689,-0.050434,-0.051180,-0.051924,-0.052690,-0.053389,-0.054148,-0.054847,-0.055606,-0.056304,-0.056772,-0.057578,-0.058276,-0.059049,-0.059700,-0.060471,-0.061143,-0.061841,-0.062613,-0.063278,-0.063976,-0.064734,-0.065446,-0.066158,-0.066869,-0.067594,-0.067958,-0.068690,-0.069368,-0.070045,-0.070723,-0.071401,-0.072078,-0.072729,-0.073500,-0.074177,-0.074854,-0.075516,-0.076246,-0.076923,-0.077587,-0.078310,-0.078687,-0.079364,-0.080027,-0.080762,-0.081392,-0.082079,-0.082716,-0.083391,-0.084067,-0.084743,-0.085418,-0.086093,-0.086769,-0.087456,-0.088098,-0.088726,-0.089138,-0.089825,-0.090466,-0.091106,-0.091759,-0.092353,-0.092981,-0.093655,-0.094341,-0.094979,-0.095625,-0.096264,-0.096891,-0.097551,-0.098282,-0.098583,-0.099221,-0.099860,-0.100471,-0.101208,-0.101833,-0.102517,-0.103154,-0.103803,-0.104382,-0.105065,-0.105701,-0.106325,-0.107006,-0.107648,-0.108272,-0.108635,-0.109316,-0.109951,-0.110597,-0.111197,-0.111786,-0.112395,-0.113127,-0.113749,-0.114393,-0.115130,-0.115877,-0.116590,-0.117269,-0.117901,-0.118545,-0.118819,-0.119446,-0.120123,-0.120754,-0.121374,-0.122039,-0.122715,-0.123334,-0.124009,-0.124650,-0.125232,-0.125856,-0.126531,-0.127137,-0.127857,-0.128463,-0.128858,-0.129542,-0.130112,-0.130783,-0.131406,-0.132067,-0.132749,-0.133329,-0.133954,-0.134569,-0.135218,-0.135913,-0.136629,-0.137242,-0.137910,-0.138201,-0.138916,-0.139528,-0.140196,-0.140797,-0.141489,-0.142181,-0.142874,-0.143566,-0.144266,-0.144929,-0.145584,-0.146229,-0.146930,-0.147575,-0.148275,-0.148561,-0.149251,-0.149940,-0.150629,-0.151317,-0.152012,-0.152710,-0.153352,-0.154050,-0.154692,-0.155379,-0.156076,-0.156707,-0.157430,-0.158162,-0.158848,-0.159249,-0.159934,-0.160609,-0.161331,-0.162062,-0.162746,-0.163411,-0.164187,-0.164861,-0.165591,-0.166255,-0.167030,-0.167702,-0.168419,-0.169174,-0.169939,-0.170474,-0.171183,-0.171938,-0.172702,0.173420,0.172184,0.170957,0.169666,0.168485,0.167193,0.166001,0.164761,0.163561,0.162361,0.161161,0.159774,0.158573,0.157372,0.156162,0.154998,0.153843,0.152641,0.151431,0.150275,0.149064,0.147899,0.146733,0.145575,0.144410,0.143253,0.142033,0.140671,0.139597,0.138423,0.137312,0.136091,0.134971,0.133797,0.132676,0.131510,0.130335,0.129214,0.128039,0.126910,0.125765,0.124729,0.123591,0.122353,0.121278,0.120087,0.119041,0.117958,0.116828,0.115691,0.114599,0.113507,0.112416,0.111317,0.110271,0.109186,0.108049,0.106949,0.105888,0.104804,0.103758,0.102658,0.101605,0.100551,0.099490,0.098475,0.097467,0.096421,0.095328,0.094229,0.093175,0.092115,0.091099,0.090091,0.088992,0.087976,0.086954,0.085985,0.084969,0.083948,0.082978,0.081956,0.080979,0.080009,0.078994,0.077972,0.076996,0.076013,0.075075,0.074143,0.073173,0.072145,0.071214,0.070237,0.069248,0.068355,0.067417,0.066485,0.065503,0.064565,0.063621,0.062733,0.061751,0.060819,0.059837,0.058893,0.058071,0.057177,0.056234,0.055334,0.054429,0.053568,0.052713,0.051819,0.050875,0.049976,0.049071,0.048205,0.047392,0.046482,0.045665,0.044803,0.044018,0.043162,0.042252,0.041429,0.040611,0.039744,0.038925,0.038064,0.037197,0.036374,0.035544,0.034720,0.033892,0.033110,0.032286,0.031609,0.030823,0.030037,0.029250,0.028467,0.027634,0.026893,0.026068,0.025239,0.024448,0.023702,0.022914,0.022127,0.021335,0.020585,0.019825,0.019303,0.018552,0.017805,0.017012,0.016257,0.015546,0.014794,0.014045,0.013249,0.012537,0.011781,0.011069,0.010309,0.009638,0.008872,0.008196,0.007739,0.007028,0.006230,0.005510,0.004829,0.004148,0.003464,0.002825,0.002103,0.001424,0.000696,0.000014,-0.000669,-0.001352,-0.002036,-0.002720,-0.003114,-0.003760,-0.004447,-0.005096,-0.005742,-0.006436,-0.007088,-0.007701,-0.008313,-0.008964,-0.009615,-0.010264,-0.010951,-0.011641,-0.012295,-0.012558,-0.013173,-0.013826,-0.014482,-0.015100,-0.015716,-0.016373,-0.016994,-0.017576,-0.018194,-0.018858,-0.019442,-0.020064,-0.020650,-0.021234,-0.021856,-0.022090,-0.022714,-0.023307,-0.023895,-0.024484,-0.025072,-0.025699,-0.026252,-0.026843,-0.027398,-0.027989,-0.028550,-0.029140,-0.029769,-0.030325,-0.030953,-0.031200,-0.031722,-0.032317,-0.032881,-0.033475,-0.034113,-0.034319,-0.032140,-0.029981,-0.027840,-0.025716,-0.023607,-0.021512,-0.019429,-0.017357,-0.015296,-0.010225,-0.008186,-0.006153,-0.004124,-0.002099,-0.000075,0.001953,0.000977};

// Create an array of pointers to the PD LUTs
const float * LUTArray[] = { PDSquareLUT, PDWave4LUT, PDWave5LUT, PDSawLUT, PDWave3LUT };
const uint8_t NoOfLUTs = sizeof(LUTArray) / sizeof(LUTArray[0]);




//	Use extern C to allow linker to find ISR
extern "C"
{
	void TIM3_IRQHandler(void) {
		// Send next samples to DAC
		if (TIM3->SR & TIM_SR_UIF) 						// if UIF flag is set
		{
			TIM3->SR &= ~TIM_SR_UIF;					// clear UIF flag
			DAC->SWTRIGR |= DAC_SWTRIGR_SWTRIG1;		// Tell the DAC to output the next value
			DAC->SWTRIGR |= DAC_SWTRIGR_SWTRIG2;		// Tell the DAC to output the next value

			if (DacRead == 1)							// If the buffer has not been refilled increment overrun warning
				overrun++;

			DacRead = 1;
		}
	}

	void EXTI15_10_IRQHandler(void) {
		// Read PC10 and PC12 for octave up and down switch
		if (GPIOC->IDR & GPIO_IDR_IDR_10)
			RelPitch = OCTAVEUP;
		else if (GPIOC->IDR & GPIO_IDR_IDR_12)
			RelPitch = OCTAVEDOWN;
		else
			RelPitch = NONE;
		EXTI->PR |= EXTI_PR_PR10 | EXTI_PR_PR12;		// Clear interrupt pending
	}

	void EXTI9_5_IRQHandler(void) {
		// Read PB8 - DAC2 Output to Mix mode
		MixOn = (GPIOB->IDR & GPIO_IDR_IDR_8);

		EXTI->PR |= EXTI_PR_PR8;						// Clear interrupt pending
	}
}


//	Interpolate between two positions (derived from a float and its rounded value) in a LUT
float Interpolate(float* LUT, float& LUTPosition)
{
	float s1 = LUT[(int) LUTPosition];
	float s2 = LUT[((int) LUTPosition + 1) % LUTSIZE];
	return s1 + ((s2 - s1) * (LUTPosition - (int)LUTPosition));
}

// Generate a phase distorted sine wave - pass LUT containing PD offsets, LUT position as a fraction of the wave cycle and a scaling factor
float GetPhaseDist(const float* PdLUT, const float LUTPosition, const float scale = 1, const float offset = 0){
	PhaseDist = PdLUT[(int)(LUTPosition * LUTSIZE)] * LUTSIZE * scale;

	// Add main wave position to phase distortion position and ensure in bounds
	float Pos = ((LUTPosition + offset) * LUTSIZE) + PhaseDist;
	while (Pos > LUTSIZE)
		Pos -= LUTSIZE;
	while (Pos < 0)
		Pos =  LUTSIZE + Pos;

	return Interpolate(SineLUT, Pos); 	//	interpolate samples
}

// Generate a phase distorted sine wave - pass LUT containing PD offsets, LUT position as a fraction of the wave cycle and a scaling factor
float GetBlendPhaseDist(const float PDBlend, const float LUTPosition, const float scale, const float& offset){
	// get the two PD LUTs that will be blended
	const float* PdLUTBlendA = LUTArray[(uint8_t)PDBlend];
	const float* PdLUTBlendB = LUTArray[(uint8_t)(PDBlend + 1) % NoOfLUTs];

	// Get the values from each LUT for the sample position
	float PhaseDistA = PdLUTBlendA[(int)(LUTPosition * LUTSIZE)] * LUTSIZE * scale;
	float PhaseDistB = PdLUTBlendB[(int)(LUTPosition * LUTSIZE)] * LUTSIZE * scale;

	// Get the weighted blend of the two PD amounts
	float blend = PDBlend - (uint8_t)PDBlend;
	PhaseDist = ((1 - blend) * PhaseDistA) + (blend * PhaseDistB);

	// Add main wave position to phase distortion position and ensure in bounds
	float Pos = ((LUTPosition + offset) * LUTSIZE) + PhaseDist;
	while (Pos > LUTSIZE)
		Pos -= LUTSIZE;
	while (Pos < 0)
		Pos =  LUTSIZE + Pos;

	return Interpolate(SineLUT, Pos); 	//	interpolate samples
}

void CreateLUTs(void)
{
	// Generate pitch lookup table
	for (int p = 0; p < LUTSIZE; p++){
		float power = (float)(p * 4.0f) / -583.0f;			// Reduce 583 to decrease spread
		PitchLUT[p] = 2299 * (float)std::pow(2.0f, power);	// Increase 2299 to increase pitch
	}

	// Generate Sine LUT
	for (int s = 0; s < LUTSIZE; s++){
		SineLUT[s] = sin(s * 2.0f * M_PI / LUTSIZE);
	}
}


int main(void)
{
	SystemInit();				// Activates floating point coprocessor and resets clock
	SystemClock_Config();		// Configure the clock and PLL
	SystemCoreClockUpdate();	// Update SystemCoreClock (system clock frequency) derived from settings of oscillators, prescalers and PLL

	CalibRestore(calibration);	// Restore calibration settings from flash memory
	CreateLUTs();				// Create pitch and sine wave look up tables
	InitSwitches();				// Configure switches for Ring mod, mix and octave selection
	InitDAC();					// DAC1 Output on PA4 (Pin 20); DAC2 Output on PA5 (Pin 21)
	InitTimer();				// Sample output timer 3 - fires interrupt to trigger sample output from DAC
	InitADC();					// Configure ADC for analog controls

	EXTI15_10_IRQHandler();		// Call the Interrupt event handler to set up the octave up/down switch to current position
	EXTI9_5_IRQHandler();		// Call the Interrupt event handler to set up the mix switch to current position

	while (1)
	{
		cyclecounter++;

		// Toggle Calibration mode when button pressed using simple debouncer
		if (!READ_BIT(GPIOB->IDR, GPIO_IDR_IDR_5)) {
			CalibBtn++;

			if (CalibBtn == 200) {
				Calibration = !Calibration;

				// write calibration settings to flash
				if (!Calibration) {
					calibration.Scale = 0.5f;
					//WriteToFlash(calibration);
				}
			}
		} else {
			CalibBtn = 0;
		}

		// Get Pitch from ADC and smooth
		Pitch = (Pitch + ADC_PITCH) / 2;

		// adjust frequency according to fine tune knob with some damping
		FineTune = ((15 * FineTune) + ADC_FTUNE) / 16;


		if (Calibration) {

			// Generate square wave
			if (DacRead)
			{
				// Calculate pitch directly
				//freq1 = 2299.0f * std::pow(2.0f, (float)Pitch / -583.0f);	// Increase 2299 to increase pitch
				//freq1 = PitchLUT[Pitch / 4];
				DAC->DHR12R1 = SamplePos1 > SAMPLERATE / 2 ? 4095: 0;
				DacRead = 0;
				float adjPitch = (float)Pitch + (2048 - FineTune) / 32;
				SamplePos1 += (2299.0f * std::pow(2.0f, adjPitch / -583.0f));	// Increase 2299 to increase pitch
				while (SamplePos1 >= SAMPLERATE)
					SamplePos1-= SAMPLERATE;
			}
			continue;
		}

		// Apply hysteresis on PD 2 discrete LT selector
		if (PD2Type > ADC_OSC2TYPE + 128 || PD2Type < ADC_OSC2TYPE - 128)
			PD2Type = ADC_OSC2TYPE;

		// Analog selection of PD LUT table allows a smooth transition between LUTs for DAC1 and a stepped transition for DAC2
		PDLut1 = (float)ADC_OSC1TYPE * (NoOfLUTs - 1) / 4096;
		PDLut2 = PD2Type * NoOfLUTs / 4096;

		// Ready for next sample
		if (DacRead)
		{
			// Get modulation from ADC; Currently seeing 0v as ~3000 and 5V as ~960
			PD1Scale = (float)std::min((3800 - ADC_PD1AMT) + ADC_PD1POT, 5000) / 800;		// Convert PD amount for OSC1
			PD2Scale = (float)std::min((4096 - ADC_PD2AMT) + ADC_PD2POT, 5000) / 800;		// Convert PD amount for OSC2

			// Get VCA levels
			if (ADC_VCA > 4070)	VCALevel = 0;									// Filter out very low level VCA signals
			else				VCALevel = (4096.0f - ADC_VCA) / 4096;			// Convert ADC for VCA to float between 0 and 1

			// Calculate output as a float from -1 to +1 checking phase distortion and phase offset as required
			float SampleOut1 = GetBlendPhaseDist(PDLut1, SamplePos1 / SAMPLERATE, PD1Scale, 0);
			float SampleOut2 = GetPhaseDist(LUTArray[PDLut2], SamplePos2 / SAMPLERATE, PD2Scale, 0);

			// Set DAC output values for when sample interrupt next fires
			if (RingModOn) {
				DAC->DHR12R1 = (int)((1 + (SampleOut1 * SampleOut2) * VCALevel) * 2047);		// Ring mod of 1 * 2
			} else {
				DAC->DHR12R1 = (int)((1 + SampleOut1 * VCALevel) * 2047);
			}
			if (MixOn) {
				DAC->DHR12R2 = (int)(((2 + (SampleOut1 + SampleOut2) * VCALevel) / 2) * 2047);	// Mix of 1 + 2
			} else {
				DAC->DHR12R2 = (int)((1 + SampleOut2 * VCALevel) * 2047);
			}

			DacRead = 0;		// Clear ready for next sample flag

			// adjust frequency according to fine tune knob with some damping
			FineTune = ((15 * FineTune) + ADC_FTUNE) / 16;

			freq1 = PitchLUT[(Pitch + ((2048 - FineTune) / 32)) / 4];		// divide by four as there are 1024 items in DAC CV Voltage to Pitch Freq LUT and 4096 possible DAC voltage values

			//	Coarse tuning - add some hysteresis to prevent jumping
			if (CoarseTune > ADC_CTUNE + 128 || CoarseTune < ADC_CTUNE - 128)
				CoarseTune = ADC_CTUNE;

			if (CoarseTune > 3412)
				freq1 *= 4;
			else if (CoarseTune > 2728)
				freq1 *= 2;
			else if (CoarseTune < 682)
				freq1 /= 4;
			else if (CoarseTune < 1364)
				freq1 /= 2;


			// octave down
			switch(RelPitch) {
				case NONE: 			freq2 = freq1; 		break;
				case OCTAVEDOWN:	freq2 = freq1 / 2;	break;
				case OCTAVEUP: 		freq2 = freq1 * 2;	break;
			}

			// jump forward to the next sample position
			SamplePos1 += freq1;
			while (SamplePos1 >= SAMPLERATE)
				SamplePos1-= SAMPLERATE;

			SamplePos2 += freq2;
			while (SamplePos2 >= SAMPLERATE)
				SamplePos2-= SAMPLERATE;
		}

		// Toggle Ring mod when button pressed
		if (READ_BIT(GPIOC->IDR, GPIO_IDR_IDR_6)) {
			if (!ButtonDown) {
				RingModOn = !RingModOn;
				ButtonDown = true;
			}
		} else {
			ButtonDown = false;
		}




	}
}

